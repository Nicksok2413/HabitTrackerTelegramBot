# =================================================================
# Этап 1: "builder" - Среда для сборки зависимостей
# =================================================================
# Используем легковесный образ Python
FROM python:3.12-slim as builder

# Устанавливаем рабочую директорию
WORKDIR /app

# Устанавливаем переменные окружения для Poetry
# POETRY_NO_INTERACTION=1: отключает интерактивные запросы
# POETRY_VIRTUALENVS_CREATE=false: заставляет Poetry устанавливать зависимости в системный python,
# что является стандартной практикой для Docker-контейнеров.
ENV POETRY_NO_INTERACTION=1 \
    POETRY_VIRTUALENVS_CREATE=false

# Устанавливаем саму Poetry
RUN pip install poetry

# Копируем файлы с зависимостями.
# Мы копируем только их, а не весь код, чтобы Docker мог закэшировать этот слой.
# Этот слой будет пересобираться только если pyproject.toml или poetry.lock изменятся.
COPY pyproject.toml poetry.lock ./

# Устанавливаем зависимости.
# --no-dev: не устанавливаем зависимости для разработки (pytest, ruff и т.д.) в production-образ.
RUN poetry install --no-dev --no-root


# =================================================================
# Этап 2: "runner" - Финальный образ для запуска приложения
# =================================================================
FROM python:3.12-slim as runner

# Устанавливаем рабочую директорию
WORKDIR /app

# Создаем пользователя без root-прав для запуска приложения
# Это важный шаг для безопасности.
RUN useradd -m -s /bin/bash appuser
USER appuser

# Копируем установленные зависимости из образа "builder"
COPY --from=builder /app /app

# Копируем исходный код нашего приложения.
# Этот слой будет пересобираться при каждом изменении в директории src.
COPY ./src ./src

# Указываем, что контейнер будет слушать на порту 8000
EXPOSE 8000

# Команда для запуска приложения будет указана в docker-compose.yml,
# но хорошей практикой является дублирование ее здесь как CMD по умолчанию.
# Это позволяет запускать контейнер командой `docker run <image_name>`
CMD ["uvicorn", "src.api.main:app", "--host", "0.0.0.0", "--port", "8000"]```
